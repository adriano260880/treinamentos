
<!DOCTYPE html>
<html>
<head>
  <title>Placar Machado Team</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      text-align: center;
    }

    .container {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .fighter {
      width: 40%;
      padding: 20px;
      border-radius: 10px;
    }

    .blue { background: #7b9bfc; }
    .red { background: #fa8282; }

    .score {
      font-size: 80px;
      margin: 10px 0;
    }

    .advpen {
      font-size: 40px;
      margin: 10px 0;
    }

    .controls button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
    }

    .timer {
      font-size: 60px;
      margin-top: 20px;
    }

    .winner {
      border: 5px solid gold;
    }

    .positive-btn {
        background-color: #ffd700;
        color: black;
        font-weight: bold;
    }

    .negative-btn {
        background-color: #f30a0a;
        color: white;
        font-weight: bold;
    }
  </style>
</head>
<body>
<h1>Placar Machado Team</h1>

<!-- ================= SETUP SCREEN ================= -->

<div id="setupScreen">
  <h2>Iniciar</h2>

  <div>
    <input id="setupNameA" placeholder="Atleta A">
  </div>
  <br>
  <div>
    <input id="setupNameB" placeholder="Atleta B">
  </div>
  <br>
  <div>
    <input id="setupTime" placeholder="Tempo em minutos">
  </div>
  <br>
  <button onclick="createMatch()">Criar Luta</button>
</div>

<!-- ================= SCOREBOARD ================= -->

<div id="scoreboard" style="display:none;">

  <div class="timer" id="timer">00:00</div>
  <button onclick="startTimer()">Start</button>
  <button onclick="pauseTimer()">Pause</button>
  <button onclick="resetMatch()">Reset</button>

  <div class="container">

    <div class="fighter blue" id="fighterA">
      <h1 id="nameA"></h2>
      <div class="score"> <span id="scoreA">0</span></div>
      <div class="advpen">Vantagem: <span id="advA">0</span></div>
      <div class="advpen">Punição: <span id="penA">0</span></div>

      <div class="controls">
        <button class="positive-btn" onclick="addPoints('A',2)">+2</button>
        <button class="positive-btn" onclick="addPoints('A',3)">+3</button>
        <button class="positive-btn" onclick="addPoints('A',4)">+4</button>
      </div>
      
      <div class="controls">
        <button class="negative-btn" onclick="subtractPoints('A',2)">-2</button>
        <button class="negative-btn" onclick="subtractPoints('A',3)">-3</button>
        <button class="negative-btn" onclick="subtractPoints('A',4)">-4</button>
      </div>
      <div class="controls">
        <button class="positive-btn" onclick="addAdv('A')">Vantagem +</button>
        <button class="positive-btn" onclick="addPen('A')">Punição +</button>
      </div>
      <div class="controls">
        <button class="negative-btn" onclick="subAdv('A')">Vantagem -</button>
        <button class="negative-btn" onclick="subPen('A')">Punição -</button>
      </div>
    </div>

    <div class="fighter red" id="fighterB">
      <h1 id="nameB"></h2>
      <div class="score"><span id="scoreB">0</span></div>
      <div class="advpen">Vantagem: <span id="advB">0</span></div>
      <div class="advpen">Punição: <span id="penB">0</span></div>

      <div class="controls">
        <button class="positive-btn" onclick="addPoints('B',2)">+2</button>
        <button class="positive-btn" onclick="addPoints('B',3)">+3</button>
        <button class="positive-btn" onclick="addPoints('B',4)">+4</button>
      </div>
      
      <div class="controls">
        <button class="negative-btn" onclick="subtractPoints('B',2)">-2</button>
        <button class="negative-btn" onclick="subtractPoints('B',3)">-3</button>
        <button class="negative-btn" onclick="subtractPoints('B',4)">-4</button>
      </div>
      <div class="controls">
        <button class="positive-btn" onclick="addAdv('B')">Vantagem +</button>
        <button class="positive-btn" onclick="addPen('B')">Punição +</button>
      </div>
      <div class="controls">
        <button class="negative-btn" onclick="subAdv('B')">Vantagem -</button>
        <button class="negative-btn" onclick="subPen('B')">Punição -</button>
      </div>
    </div>

  </div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const isPublicView = params.get("view") === "public";

let state = {
  A: { points: 0, adv: 0, pen: 0 },
  B: { points: 0, adv: 0, pen: 0 },
  time: 0,
  interval: null
};

function syncLocal() {
  if (isPublicView) return;
  localStorage.setItem("matchState", JSON.stringify({
    A: state.A,
    B: state.B,
    time: state.time,
    nameA: nameA.innerText,
    nameB: nameB.innerText
  }));
}

function updateUI() {
  scoreA.innerText = state.A.points;
  scoreB.innerText = state.B.points;
  advA.innerText = state.A.adv;
  advB.innerText = state.B.adv;
  penA.innerText = state.A.pen;
  penB.innerText = state.B.pen;

  let minutes = Math.floor(state.time / 60);
  let seconds = state.time % 60;
  timer.innerText =
    String(minutes).padStart(2,'0') + ":" +
    String(seconds).padStart(2,'0');

  syncLocal();
}

window.addEventListener("storage", (event) => {
  if (event.key === "matchState" && isPublicView) {
    const data = JSON.parse(event.newValue);
    state.A = data.A;
    state.B = data.B;
    state.time = data.time;
    nameA.innerText = data.nameA;
    nameB.innerText = data.nameB;
    updateUI();
  }
});

function addPoints(p,v){ state[p].points+=v; updateUI(); }
function subtractPoints(p,v){ if(state[p].points>=v){ state[p].points-=v; updateUI(); }}
function addAdv(p){ state[p].adv++; updateUI(); }
function subAdv(p){ if(state[p].adv>0){ state[p].adv--; updateUI(); }}
function addPen(p){ state[p].pen++; updateUI(); }
function subPen(p){ if(state[p].pen>0){ state[p].pen--; updateUI(); }}

function startTimer(){
  if(state.interval) return;
  state.interval=setInterval(()=>{
    if(state.time>0){ 
        state.time--; 
        updateUI();
    } else {
        clearInterval(state.interval);
        generateMatchLog();
    }
  },1000);
}

function pauseTimer(){ 
    clearInterval(state.interval); state.interval=null;
    
}

function resetMatch(){
  pauseTimer();
  generateMatchLog();
  state.A={points:0,adv:0,pen:0};
  state.B={points:0,adv:0,pen:0};
  state.time=0;
  updateUI();
}

function createMatch(){
  nameA.innerText = setupNameA.value || "Atleta A";
  nameB.innerText = setupNameB.value || "Atleta B";
  state.time = parseInt(setupTime.value)*60 || 0;

  setupScreen.style.display="none";
  scoreboard.style.display="block";
  updateUI();
}

if(isPublicView){
  document.querySelectorAll(".controls,#refControls,button").forEach(el=>el.style.display="none");
  document.body.style.cursor="none";

  const saved=localStorage.getItem("matchState");
  if(saved){
    const data=JSON.parse(saved);
    state.A=data.A;
    state.B=data.B;
    state.time=data.time;
    nameA.innerText=data.nameA;
    nameB.innerText=data.nameB;
    setupScreen.style.display="none";
    scoreboard.style.display="block";
    updateUI();
  }
}

function generateMatchLog() {
  const winner =
    state.A.points > state.B.points ? nameA.innerText :
    state.B.points > state.A.points ? nameB.innerText :
    "Draw";

  const now = new Date().toLocaleTimeString("pt-BR");

  const csvContent =
    "Hora; Nome; Pontos; Vantagem; Punição; Nome; Pontos; Vantagem; Punição\n" +
    `${now};${nameA.innerText};${state.A.points};${state.A.adv};${state.A.pen};` +
    `${nameB.innerText};${state.B.points};${state.B.adv};${state.B.pen}`;

  const blob = new Blob([csvContent], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = now+nameA.innerText+nameB.innerText+".csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>